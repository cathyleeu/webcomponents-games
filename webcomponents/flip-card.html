<link rel="import" href="../public/components/polymer/polymer-element.html">

<dom-module id="flip-card">
  <template>
    <style>
      :host {
        width: 800px;
        height: 800px;
        position: absolute;
      }

      .card-cont {
        width: 180px;
        height: 180px;
        display:inline-block;
        position: relative;
        perspective: 180px;
        margin: 0.5em 0.5em 0;
      }

      [id^="card"] {
        width: 100%;
        height: 100%;
        position: absolute;
        -webkit-transform-style: preserve-3d;
          /* -moz-transform-style: preserve-3d;
             -o-transform-style: preserve-3d; */
                transform-style: preserve-3d;

        -webkit-transition: transform 1s;
         /*  -moz-transition: transform 1s;
             -o-transition: transform 1s; */
                transition: transform 1s;
      }

      [id^="card"] figure{
        margin: 0;
        display: block;
        position: absolute;
        width: 100%;
        height: 100%;
        -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
      }

      [id^="card"] .front{
        border-radius: 5px;
        border: 5px solid #2ECC98;
        background: white;
      }
      [id^="card"] .back {
        border-radius: 5px;
        border: 5px solid #2ECC98;
        background: #2ECC98;
        left: -10px;
        transform: rotateY(180deg);
      }

      [id^="card"].flipped {
        transform: rotateY(180deg);
      }

      .card-img{
        width: 180px;
        height: 180px;
        background-position: center center;
        background-repeat: no-repeat;
      }

      .card-front-logo{
        width: 80px;
        height: 60px;
        margin-left: 55px;
        left: 50%;
        margin-top: 60px;
        top: 50%;
        background-position: center center;
        background-repeat: no-repeat;
      }
    </style>
  </template>

  <script>
    class FlipCard extends Polymer.Element {
      static get is() { return 'flip-card'; }
      connectedCallback() {
        super.connectedCallback();
        this.shadowRoot.namespaceURI = d3.namespaces.xhtml;
      }
      setData(val){
        let i, j, temp;
        this.data = val.concat(val);
        for(i = 1; i < this.data.length; i++) {
          j = Math.floor(Math.random() * (i+1));
          temp = this.data[i];
          this.data[i] = this.data[j];
          this.data[j] = temp;
        }
        var board = d3.select(this.shadowRoot);
        var tags = ["front", "back"],
            flipped = 0;

        board.selectAll('div').remove();
        let card = board.selectAll('div')
            .data(this.data).enter()
            .append('div')
            .classed('card-cont', true);

        const transition_end_events = 'webkitTransitionEnd transitionend msTransitionEnd oTransitionEnd';
        let flipper = card.append('div')
            .attr('id', (d,i) => `card-${i}`)
            .on('click', function(d, i) {
              const flipped_el = board.selectAll('.flipped');
              if(flipped_el.size() < 2) {
                d3.select(this).classed("flipped", true);
              }
            })
            .on(transition_end_events, function(d, i) {
              if(d3.select(this).classed("flipped")) {
                flipped++;
                if(flipped == 2) {
                  const flipped_el = board.selectAll('.flipped');
                  flipped = 0;
                  if(flipped_el.data()[0] == flipped_el.data()[1]) {
                    flipped_el.remove();
                  } else {
                    flipped_el.classed("flipped", false);
                  }
                }
              }
            });

        let cardItem = flipper.selectAll('figure')
            .data(tags).enter()
            .append('figure')
            .attr('class', (d,i) => d)
        this.data.map( (item,i) => board.selectAll(`#card-${i}`)
                .select('.back')
                .html(`<img src=${item} class="card-img" />`)
            );

        this.data.map( (_,i) => board.selectAll(`#card-${i}`)
                .select('.front')
                .html('<img src="https://toycode.org/img/kidsthinking_big.png" class="card-front-logo"/>'));
      }

    }
    window.customElements.define(FlipCard.is, FlipCard);
  </script>
</dom-module>
