<link rel="import" href="../components/polymer/polymer-element.html">
<link rel="import" href="../components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./status-bar.html">
<link rel="import" href="./modal.html">

<dom-module id="select-card">
  <template>
    <style>
      rect{
        stroke-width: 8;
        stroke: gray;
        cursor: pointer;
      }
      /*rect.clicked {
        stroke: "#2ECC98";
      }*/
    </style>
    <status-bar
      title="{{localize('title')}}"
      score="{{localize('score')}}"
      lefted="{{localize('lefted')}}"
      hasname="{{handleCheckName()}}"
      total="{{total}}"
      point="{{point}}"
      matched="{{matched}}"
      cards="{{cards}}"
      on-modal="handleModal"
      ></status-bar>
      <div>
        <h1>아래의 그림 중 대중교통을 클릭하세요.</h1>
        <h3>힌트! 아래의 카드 중 대중교통은 4가지가 있어요!</h3>
      </div>
  </template>
  <script>
    class SelectCard extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() { return 'select-card'; }
      connectedCallback() {
        super.connectedCallback();
        let svg = d3.select(this.shadowRoot)
          .append("svg")
          .attr('width', this.offsetWidth )
          .attr('height', `${this.offsetHeight-60}`);
      }
      ready(){
        super.ready();
        this.set('clicked', 0)
      }
      setData(data, manifest){
        let _this = this,
            svg = d3.select(this.shadowRoot).select('svg');

        manifest = Object.assign(...manifest.map(o => ({[o.id]: o.src})));
        data = data.map(id=>manifest[id]);
        this.set('cards', data.length );

        let defs = svg.append('defs').selectAll('pattern')
        let shuffled = d3.shuffle(data)
        let selectImgs = defs.data(shuffled).enter()
            .append('pattern')
            .attr("id", (d, i) => `drop_${i}`)
            .attr("x", 0).attr("y", 0)
            .attr("width", 1).attr("height", 1)
            .attr("patternUnits", "objectBoundingBox")
            .append('image')
            .attr("x", 5).attr("y", 5)
            .attr("width", 100).attr("height", 100)
            .attr("xlink:href", (d, i) => `${d}`)

        let selectBox = svg.append('g')
            .selectAll('rect')
            .data(shuffled).enter()
            .append('rect')
            .attr("rx", 5).attr("ry", 5)
            .attr('x', (d, i) => (100*i) + (20*i)).attr('y', 100)
            .attr("width", 110).attr("height", 110)
            .style("fill", (d,i) => `url(#drop_${i})`)
            .on('click touchstart', this.handelClickCard)
      }
      handelClickCard(d, i){
        let that = d3.select('#element').node(),
            clickedSize = d3.select(that.shadowRoot).selectAll('.clicked').size();
        if(clickedSize >= 4) {
          alert("더이상 클릭 못함 ^^")
        } else {
          this.classList.toggle('clicked')
        }

        if(this.classList.value){
          d3.select(this).style('stroke', "#2ECC98")
        }
        let correct = d3.select('#element').attr('correct').split(',').indexOf(d)
        if(correct === -1) {
          console.log("correct")
        }
      }
    }
    window.customElements.define(SelectCard.is, SelectCard);
  </script>
</dom-module>
