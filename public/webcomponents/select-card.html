<link rel="import" href="../components/polymer/polymer-element.html">
<link rel="import" href="../components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./status-bar.html">
<link rel="import" href="./modal.html">

<dom-module id="select-card">
  <template>
    <style>
      rect{
        stroke-width: 8;
        stroke: gray;
        cursor: pointer;
      }
      .header {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      h1, h3 , p{
        margin: 0.3em;
        font-weight: 400;
      }
      .container {
        display: inline-block;
      	position: relative;
      	width: 100%;
      	padding-bottom: 30%;
      	vertical-align: middle;
      	overflow: hidden;
      }

      .svg--responsive {
        display: inline-block;
        position: absolute;
        top: 0;
        left: 0;
      }
      button {
        display: block;
        width: 120px;
        height: 40px;
        margin: 0 auto 10px auto;
        background: none;
        border: 3px solid #2ECC98;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        box-sizing: border-box;
        transition: all .3s ease-in-out;
        color: #2ECC98;
      }
      button:hover {
				background: #2ECC98;
				color: #fff;
			}
    </style>
    <status-bar
      title="{{localize('title')}}"
      score="{{localize('score')}}"
      lefted="{{localize('lefted')}}"
      hasname="{{handleCheckName()}}"
      total="{{total}}"
      point="{{point}}"
      matched="{{matched}}"
      purpose="select"
      cards="{{cards}}"
      on-modal="handleModal"
      ></status-bar>
      <toycode-modal
        id="retryModal"
        purpose="retry"
        headertext="{{localize('retryHead')}}"
        btmtext="{{localize('retryBtm')}}"
        retrybtn="{{localize('retrybtn')}}"
        ></toycode-modal>
      <toycode-modal
        id="successModal"
        purpose="nextStep"
        headertext="{{localize('successHead')}}"
        btmtext="{{localize('successBtm')}}"
        nextbtn="{{localize('nextbtn')}}"
        ></toycode-modal>
      <toycode-modal
        id="logOutModal"
        headertext="{{localize('logoutHead')}}"
        btmtext="{{localize('logoutBtm')}}"
        yesbtn="{{localize('yesbtn')}}"
        nobtn="{{localize('nobtn')}}"
        purpose="logout"
        ></toycode-modal>
      <toycode-modal
        id="previousModal"
        headertext="{{localize('previousHead')}}"
        btmtext="{{localize('previousBtm')}}"
        yesbtn="{{localize('yesbtn')}}"
        nobtn="{{localize('nobtn')}}"
        purpose="previous"
        ></toycode-modal>
      <div class="header">
        <h3>{{localize('subtitle')}}</h3>
        <p>{{localize('guide')}}</p>
      </div>
      <div class="container">
        <svg class="svg--responsive"></svg>
      </div>
      <div class="bottom">
        <button on-click="handleSubmit">{{localize('resultbtn')}}</button>
      </div>

  </template>
  <script>
    class SelectCard extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() { return 'select-card'; }
      connectedCallback() {
        super.connectedCallback();
        let svg = d3.select(this.shadowRoot).select('svg')
          .attr('width', '100%' ).attr('height', '100%');
      }
      ready(){
        super.ready();
        this.set('clicked', 0)
        this.set('uncorrect', [])
        this.set('point', 0)
        this.set('total', 0)
      }
      reset(){
        this.set('clicked', 0)
        this.set('total', 0)
        this.set('point', this.point+5)
        d3.select(this.shadowRoot).select('svg').selectAll('*').remove()
        this.setData(this.data, this.manifest)
      }
      handleSortData(boolean) {
        return Object.assign(this.manifest.filter( d => boolean ? d.result : !d.result ).map(o => o.src));
      }
      setData(data, manifest){
        this.set('manifest', manifest )
        let _this = this,
            svg = d3.select(this.shadowRoot).select('svg'),
            trueData = this.handleSortData(true),
            falseData = d3.shuffle(this.handleSortData(false)),
            wholeData = d3.shuffle(trueData.concat(falseData.slice(0,3)));
        this.set('correct', trueData )


        let defs = svg.append('defs').selectAll('pattern')
        let selectImgs = defs.data(wholeData).enter()
            .append('pattern')
            .attr("id", (d, i) => `fill_${i}`)
            .attr("x", 0).attr("y", 0)
            .attr("width", 1).attr("height", 1)
            .attr("patternUnits", "objectBoundingBox")
            .append('image')
            .attr("x", 5).attr("y", 5)
            .attr("width", 100).attr("height", 100)
            .attr("xlink:href", (d, i) => `${d}`)

        let selectBox = svg.append('g')
            .selectAll('rect')
            .data(wholeData).enter()
            .append('rect')
            .attr("rx", 5).attr("ry", 5)
            .attr('x', (d, i) => (100*i) + (20*i)).attr('y', 100)
            .attr("width", 110).attr("height", 110)
            .style("fill", (d, i) => `url(#fill_${i})`)
            .on('click', this.handleClickCard )


        let getSize = d3.select(this.shadowRoot).select('g').node().getBBox().width
        let getCenter = (this.offsetWidth - getSize)/2;
        d3.select(this.shadowRoot).select('g').attr('transform', `translate(${getCenter},0)`)
      }
      handleClickCard(d, i){
        let that = d3.select('#element').node(),
            selected = that.correct.some(s => s === d),
            uncorrect = that.uncorrect.some(s => s === d);

        this.classList.toggle('clicked')
        if(this.classList.value){
          !selected && that.push('uncorrect', d)
          d3.select(this).style('stroke', "#2ECC98")
          that.set('clicked', that.clicked+1)
        } else {
          uncorrect && that.pop('uncorrect', d )
          d3.select(this).style('stroke', "gray")
          that.set('clicked', that.clicked-1)
        }
      }
      handleSubmit(){
        if(this.clicked < 4) {
          alert(this.resources[this.language].noticeAlert)
          return false
        }
        this.uncorrect[0] ? this.$.retryModal.modalAlert() : this.$.successModal.modalAlert()
      }
    }
    window.customElements.define(SelectCard.is, SelectCard);
  </script>
</dom-module>
