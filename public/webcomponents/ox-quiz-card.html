<link rel="import" href="../components/polymer/polymer-element.html">
<link rel="import" href="../components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="./status-bar.html">
<link rel="import" href="./modal.html">

<dom-module id="ox-quiz-card">
  <template>
    <style>
      .header {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      h1, h3 , p{
        margin: 0.3em;
        font-weight: 400;
      }
      .answers {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }
      .letter {
        font-size: 120px;
        font-family: Helvetica;
        font-weight: Bold;
        color: rgba(18,22,26,0.7);
        width: 120px;
        height: 120px;
        text-align: center;
        vertical-align: middle;
        line-height: 120px;
        border: 10px solid #2ECC98;
        border-radius: 15px;
        margin: 0.5em;
        cursor: pointer;
      }
      .quiz {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
      }
      img {
        width: 150px;
        height: 150px;
        background-position: center center;
        background-repeat: no-repeat;
      }
      button {
        display: block;
        width: 120px;
        height: 40px;
        margin: 0 auto 10px auto;
        background: none;
        border: 3px solid #2ECC98;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        box-sizing: border-box;
        transition: all .3s ease-in-out;
        color: #2ECC98;
      }
      button:hover {
				background: #2ECC98;
				color: #fff;
			}

    </style>
    <status-bar
      title="{{localize('title')}}"
      score="{{localize('score')}}"
      lefted="{{localize('lefted')}}"
      hasname="{{handleCheckName()}}"
      total="{{total}}"
      point="{{point}}"
      matched="{{matched}}"
      purpose="select"
      cards="{{cards}}"
      on-modal="handleModal"
      ></status-bar>
      <toycode-modal
        id="retryModal"
        purpose="retry"
        headertext="{{localize('retryHead')}}"
        btmtext="{{localize('retryBtm')}}"
        retrybtn="{{localize('retrybtn')}}"
        ></toycode-modal>
      <toycode-modal
        id="successModal"
        purpose="nextStep"
        headertext="{{localize('successHead')}}"
        btmtext="{{localize('successBtm')}}"
        nextbtn="{{localize('nextbtn')}}"
        ></toycode-modal>
      <toycode-modal
        id="logOutModal"
        headertext="{{localize('logoutHead')}}"
        btmtext="{{localize('logoutBtm')}}"
        yesbtn="{{localize('yesbtn')}}"
        nobtn="{{localize('nobtn')}}"
        purpose="logout"
        ></toycode-modal>
      <toycode-modal
        id="previousModal"
        headertext="{{localize('previousHead')}}"
        btmtext="{{localize('previousBtm')}}"
        yesbtn="{{localize('yesbtn')}}"
        nobtn="{{localize('nobtn')}}"
        purpose="previous"
        ></toycode-modal>
      <div class="header">
        <h3>{{localize('subtitle')}}</h3>
        <p>{{localize('guide')}}</p>
      </div>
      <div class="container">
      </div>
      <!-- <div class="bottom">
        <button on-click="handleSubmit">{{localize('resultbtn')}}</button>
      </div> -->
  </template>
  <script>
    class OXQuizCard extends Polymer.mixinBehaviors([Polymer.AppLocalizeBehavior], Polymer.Element) {
      static get is() { return 'ox-quiz-card'; }
      connectedCallback() {
        super.connectedCallback();
        let svg = d3.select(this.shadowRoot).select('svg')
          .attr('width', '100%' )
          .attr('height', '100%');
      }
      ready(){
        super.ready();
        this.set('clicked', 0)
        this.set('uncorrect', [])
        this.set('point', 0)
        this.set('total', 0)
        this.set('stage', 1)
      }
      // reset(){
      //   this.set('clicked', 0)
      //   this.set('total', 0)
      //   this.set('point', this.point+5)
      //   d3.select(this.shadowRoot).select('svg').selectAll('*').remove()
      //   this.setData(this.data, this.manifest)
      // }
      * shuffle(array) {
        let cardId = array.length;
        while (cardId--) {
            yield array.splice(Math.floor(Math.random() * (cardId+1)), 1)[0];
        }
      }
      setData(data, manifest){
        let _this = this,
            svg = d3.select(this.shadowRoot).select('svg');
        _this.set('data', data )
        _this.set('manifest', manifest )
        manifest = Object.assign(...manifest.map(o => ({[o.id]: o.src})));
        data = data.map(id=>manifest[id]);

        console.log(manifest, data)

        let container = d3.select(this.shadowRoot).select(".container");
        let quizCont = container.append('xhtml:div')
            .attr('class', 'quiz')

            quizCont.append('p').text(`Quiz${this.stage}`)

            quizCont.append('img')
                    .attr('src', "/img/a6_w4/sky0.png")

            quizCont.append('p').text(`는 에서도 탈 수 있어요.`)

            // quizCont.selectAll('img').data().enter()


        let answers = ['o', 'x']
        let answersCont = container.append('xhtml:div')
          .attr('class', 'answers')
          .selectAll('div')
          .data(answers).enter()
          .append('xhtml:div')
          .attr('class', 'letter')
          .text(d => d.toUpperCase())
          .on('click', (d) => console.log(d))

      }
      handleClickCard(d, i){
        let that = d3.select('#element').node(),
            correct = d3.select('#element').attr('correct').split(',').indexOf(d);
        this.classList.toggle('clicked')
        // console.log("!!!--2--!!!")
        if(this.classList.value){
          // console.log("!!!--4--!!!")
          if(correct === -1) {
            console.log("uncorrect")
            that.push('uncorrect', this.__data__)
          }
          that.set('clicked', that.clicked+1)
          d3.select(this).style('stroke', "#2ECC98")
        } else {
          // console.log("!!!--5--!!!")
          if(that.uncorrect.indexOf(d) !== -1){
            console.log("uncorrect remove")
            that.set('uncorrect', that.uncorrect.filter(ele => ele !== d))
          }
          d3.select(this).style('stroke', "gray")
          that.set('clicked', that.clicked-1)
        }
        console.log(that.clicked, that.uncorrect.length)
      }
      handleSubmit(){
        if(this.clicked < 4) {
          alert('아직 선택할 것이 남았어요!')
          return false
        }
        if(this.uncorrect.length > 0){
          this.$.retryModal.modalAlert()
          console.log(this.uncorrect.length);
        } else {
          this.$.successModal.modalAlert()
        }
      }
    }
    window.customElements.define(OXQuizCard.is, OXQuizCard);
  </script>
</dom-module>
