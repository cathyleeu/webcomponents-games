<link rel="import" href="../components/polymer/polymer-element.html">

<dom-module id="table-match">
  <template>
    <style>
      table {
        border-spacing: inherit;
        border: 1px solid;
        border-collapse: collapse;
        position: relative;
        left: 50%;
        margin: 10px 0;
        font-size: 12px;
        font-weight: 500;
      }
      thead, tfoot {
        background: purple;
      }
      th, td {
        width: 50px;
        height: 35px;
        border: 1px solid;
      }
      th {
        position: relative;
      }
      span {
        color: white;
      }
      table .sup{
        display: block;
        color: black;
        position: relative;
        width: 50%;
        float: left;
        padding-bottom: 15%;
        line-height: 100%;
        text-align: center;
        z-index: 1;
      }

      table .inf{
        display: block;
        position: relative;
        width: 50%;
        float: left;
        padding-top: 15%;
        line-height: 100%;
        text-align: center;
        z-index: 1;
      }
      table .category::after{
        content: "";
        position: absolute;
        z-index: 0;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #77C2A0;
        background-size: cover;
        clip-path: polygon(100% 0%, 0% 0%, 0% 100%);
      }
      .filled {
        background-color: #CA494A;
      }
      button {
        width: 150px;
        height: 40px;
        background-color: #7F2F7B;
        font-size: 15px;
        color: white;
        letter-spacing: 3px;
        font-weight: 500;
        border: none;
        border-radius: 25px;
      }
    </style>
    <div class="grid_board">
      <table id="question" cellspacing="0" cellpadding="0"></table>
      <table id="answer" cellspacing="0" cellpadding="0"></table>
      <button onclick="{{handleAnswer}}">제출하기</button>
    </div>
  </template>
  <script>
    class TableMatch extends Polymer.Element {
      static get is() {
        return "table-match";
      }
      static get properties() {
        return {
          pastel : {
            value : [
              "A03333", "CA494A", "E29EBE", "488A5A", "855C99",
              "EAB364", "684225", "E0764D", "5BB9D3", "4A5B5C"
            ]
          }
        }
      }
      ready(){
        super.ready();
        console.log("table match");
        this.set('pastel', d3.shuffle(this.pastel))
        this.set('result', true)

        this.renderTables()
      }
      renderTables() {
        let parent = d3.select(this.ownerDocument).select('#element').node();
        let questNode = d3.select(this.shadowRoot).select('#question');
        let anwNode = d3.select(this.shadowRoot).select('#answer');
        let range = new Array(parent.max);
        // render


        let items = parent.items


        let questNodeTbody = questNode.append('tbody').append('tr')

        questNodeTbody.append('th').text("개수")
        questNodeTbody.selectAll('td').data(items).enter()
        .append('td').attr('id', (d,i) => `quest${i}`)
        .text((d,i) => Math.floor(Math.random() * (parent.max - 1 + 1)) + 1)

        questNodeTbody.selectAll('td').nodes().forEach( (ele, i) => {
          this.set(`quest${i}`, +ele.innerText)
        })

        // 답안지 부분ㄴㄴㄴㄴ/...
        let anwNodeTr = anwNode.append('tbody').selectAll('tr').data(items).enter()
                               .append('tr').attr('id', (d,i) => `answer${i}`)
                               .attr('data-idx', (d,i) => i)

            anwNodeTr.append('th').attr('style', "background-color: #77C2A0")
            .text((d,i) => d).exit()



        anwNodeTr.nodes().forEach( (ele, i) => {
          d3.select(ele).selectAll('td').data(range).enter()
          .append('td').on('click', this.handleClickTable)
        })

        let anwNodeTF = anwNode.append('tfoot')
        let anwNodeTH = anwNodeTF.append('th').attr('class', "category")

        anwNodeTH.append('span').attr('class', "sup").text(parent.title)
        anwNodeTH.append('span').attr('class', "inf").text("개수")

        anwNodeTF.selectAll('td').data(range).enter()
            .append('td').append('span').text((d,i) => `${i+1}`)


        // items.splice(0,0,parent.title)
        let questNodeTR = questNode.append('thead').append('tr')

        questNodeTR.append('th').append('span').text(parent.title)
        questNodeTR.selectAll('td').data(items).enter()
        .append('td').append('span').text(d => d)

        // debugger

        let questCenter = questNode.node().getBoundingClientRect().width/2
        let anwCenter = anwNode.node().getBoundingClientRect().width/2


        questNode.attr('style', `margin-left: -${questCenter}px`)
        anwNode.attr('style', `margin-left: -${anwCenter}px`)



      }
      handleClickTable() {

        let node = this;
        let parent = d3.select(node.ownerDocument).select('#element').node();
        let self = d3.select(parent.shadowRoot).select("table-match").node();
        let num = (+node.parentElement.dataset.idx);
        let filled = node.className;
        let prev = node.previousElementSibling;

        if(prev.localName === "td" && prev.className === "") {
          alert("차례로 완성해주세요.")
          return
        }

        if(filled === "") {
          node.style.backgroundColor = `#${self.pastel[num]}`
        } else {
          node.style.backgroundColor = ""
        }
          node.classList.toggle('filled')

      }
      handleAnswer(){
        let parent = d3.select(this.ownerDocument).select('#element').node();
        let self = d3.select(parent.shadowRoot).select("table-match").node();

        let ansNodes = d3.select(self.shadowRoot).select('#answer').select('tbody').selectAll('tr').nodes()

        ansNodes.forEach((ele, i) => {
            let length = d3.select(ele).selectAll('.filled').nodes().length;

            if(self[`quest${i}`] !== length) {
              self.set('result', false)
              parent.$.retryModal.modalAlert()

            }
        })

        if(!self.result) {
          parent.$.retryModal.modalAlert()
          self.set('result', true )
        } else {
          if(parent.lastStage === parent.stage){
            parent.$.finalStageModal.modalAlert()
          }else {
            parent.$.successModal.modalAlert()
          }
        }

      }
    }
    window.customElements.define(TableMatch.is, TableMatch);
  </script>
</dom-module>
