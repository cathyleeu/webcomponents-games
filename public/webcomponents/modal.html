<link rel="import" href="../components/polymer/polymer-element.html">

<dom-module id="toycode-modal">
  <template>
    <style>
      :host {
        min-height:100%;
        height:100%;
        background-size:cover;
        background-position:top center;
        font-family:helvetica neue, helvetica, arial, sans-serif;
        font-weight:200;
        position: absolute;
        z-index: 100;
      }
      :host(.modal-active) {
        overflow: hidden;
      }
      #modal-container {
        position:fixed;
        display:table;
        height:100%;
        width:100%;
        top:0;
        left:0;
        transform:scale(0);
        z-index:1;
      }

      #modal-container.popup{
        z-index:0;
        transform:scale(1);
      }

      .popup > .modal-background {
        background:rgba(0,0,0,.6);
      }
      .popup > .modal-background > .modal {
        animation: moveUp .5s cubic-bezier(0.165, 0.840, 0.440, 1.000) forwards;
      }

      .popup.out .modal-background .modal {
        animation: moveDown .5s cubic-bezier(0.165, 0.840, 0.440, 1.000) forwards;
      }

      .modal-background {
        display:table-cell;
        background:rgba(0,0,0,.8);
        text-align:center;
        vertical-align:middle;
      }

      .modal-background .modal {
        background:white;
        padding:50px;
        display:inline-block;
        border-radius:3px;
        font-weight:300;
        position:relative;
      }
      .modal-background .modal h2 {
        font-size:25px;
        line-height:25px;
        margin-bottom:15px;
      }
      .modal-background .modal p {
        font-size:18px;
        line-height:22px;
      }

      .button {
        display: none;
        text-align:center;
        padding:10px 15px;
        margin:10px;
        background:red;
        font-size:18px;
        background-color:#efefef;
        border-radius:3px;
        box-shadow:0 1px 2px rgba(0,0,0,.3);
        cursor:pointer;
      }

      .button:hover {
        color:white;
        background:#009bd5;
      }
      @keyframes moveUp {
        0% {
          transform:translateY(150px);
        }
        100% {
          transform:translateY(0);
        }
      }

      @keyframes moveDown {
        0% {
          transform:translateY(0px);
        }
        100% {
          transform:translateY(150px);
        }
      }
    </style>

    <div id="modal-container">
      <div class="modal-background">
        <div class="modal">
          <h2>{{headertext}}</h2>
          <p>{{btmtext}}</p>
          <div class="button done" on-click="handleNextStep">{{nextbtn}}</div>
          <div class="button final" on-click="handleFinalStep">{{finalbtn}}</div>
          <div class="button stay" on-click="handleStayStage">{{nobtn}}</div>
          <div class="button retry" on-click="handleStayStage">{{retrybtn}}</div>
          <div class="button retryReset" on-click="handleNextStep">{{retrybtn}}</div>
          <div class="button move" on-click="handleMoveStage">{{yesbtn}}</div>
        </div>
      </div>
    </div>

  </template>
  <script>
    class Modal extends Polymer.Element {
      static get is() {
        return "toycode-modal";
      }
      static get properties() {
        return {
          headertext:String,
          btmtext:String,
          point: Number,
          total: Number,
          matched: Number,
          purpose: String,
          nextbtn: String,
          nobtn:String,
          retrybtn:String,
          yesbtn:String
        }
      }
      ready(){
        super.ready();
        this.set('element', this.shadowRoot.getElementById("modal-container"))
      }

      matchedRate(total, matched){
        let rate = (matched/total)*100
        return Math.round(rate)
      }
      modalAlert(){
        let target = {
          finalStage : '.final',
          nextStep : '.done',
          previous : '.stay, .move',
          logout : '.stay, .move',
          retry: '.retry',
          retryReset: '.retryReset'
        };
        let els = this.shadowRoot.querySelectorAll(target[this.purpose]);
        els.forEach(el=>{el.style.display="inline-block"});
        d3.select(this.element).classed("popup", "popup")
        // this.element.classList.add('popup')
      }
      handleNextStep(){
        d3.select(this.element).classed("popup", null)
        document.getElementById("element").reset()
      }
      handleMoveStage(){
        if(this.purpose === 'previous'){
          let href = `${location.origin}/code/${window.name}`
          window.open(href, window.name);
        } else {
          let codeName = window.name.split('#')[0];
          let href = `${location.origin}/code/${codeName}`
          window.open(href, window.name);
        }
      }
      handleStayStage(){
        d3.select(this.element).classed("popup", null)
      }
      handleFinalStep(){
        if(!this.nextlink){
          let href = `${location.origin}/code/${window.name}`
          console.log("window.name", window.name, "location.origin", location.origin);
          if(window.name){
            window.open(href, window.name);
          }
          d3.select(this.element).classed("popup", null)
          return false
        }
        let href = `${location.origin}/${this.nextlink}`
        d3.select(this.element).classed("popup", null)
        // this.element.classList.remove('popup')
        window.open(href, window.name)
      }
    }
    window.customElements.define(Modal.is, Modal);
  </script>
</dom-module>
