<script>
if(location.hash) {
  location.href = "/code/" + location.hash.slice(1);
}
</script>
<style>
  h1, h2, h3, h4, h5, h6 {
    text-transform: capitalize !important;
  }
  .btn-default {
    margin: 20px;
  }
  .btn-warning {
    margin: 20px;
    width: 130px;
    padding: 10px;
  }
  .btn-warning.selected {
    background-color: #E53;
  }
  .btn-outline {
     width: 300px;
     height: 60px;
     line-height: 60px;
     display: block;
     margin: 10px auto;
     padding: 0;
  }
  #characters {
    margin-bottom: 50px;
  }
  .character {
    width: 128px;
    display: inline-block;
    border: 2px solid transparent;
    border-radius: 5px;
  }
  .character.selected {
    background-color: #E53;
    border: 2px solid yellow;
  }
  h3 {
    margin-bottom: 50px;
  }
  .book-idx {
    padding: 0 10px;
    border-right: 1px solid white;
    display: inline-block;
    height: 58px;
    float: left;
    font-weight: bold;
  }
  .book-0 {
    height: 32px;
    line-height: 32px;
  }
  .book-1 {
    height: 24px;
    line-height: 24px;
    font-size: 14px;
  }
</style>

<!-- Navigation -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <a class="navbar-brand">KIDSTHINKING</a>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>

<!-- Header -->
<header>
    <div class="container" data-view="0">
        <div class="row">
            <div class="col-lg-12">
                <h1 data-msg="welcome">안녕하세요. 키즈씽킹입니다.</h1>
                <h2><span class="school"></span> <span data-msg="school"></span> (<span class="yearmonth"></span>)</h2>
                <img class="img-responsive" src="/img/kidsthinking_big.png" alt="">
                <div class="intro-text">
                    <div id="classes">
                    </div>
                    <!--hr class="star-light">
                    <span class="skills">키즈씽킹</span-->
                </div>
            </div>
        </div>
    </div>
    <div class="container" data-view="1">
        <div class="row">
            <div class="col-lg-12">
                <h1 data-msg="login">키즈씽킹 로그인</h1>
                <h2><span class="school"></span> - <span class="className"></span></h2>
                <h3><strong data-msg="login1" style="color:yellow">로그인 스티커</strong><span data-msg="login2">를 확인해주세요.</span></h3>
                <h3 data-msg="select_name">1. 이름을 선택하세요</h3>
                <div id="names">
                </div>
                <h3 data-msg="select_password">2. 비밀캐릭터나 비밀번호를 선택하세요</h3>
                <div id="characters">
                </div>
                <img id="login" src="/img/login/button.png">
            </div>
        </div>
    </div>
    <div class="container" data-view="2">
        <div class="row">
            <div class="col-lg-12">
                <h2><span class="school"></span> - <span class="className"></span></h2>
                <h3><span data-msg="kidsthinking">키즈씽킹</span> <span class="book"></span></h3>
                <div class="contents">
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Footer -->
<footer class="text-center">
    <div class="footer-below">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    Copyright &copy; (주)토이코드 2015
                </div>
            </div>
        </div>
    </div>
</footer>

<div id="modal" class="modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" tabindex="0"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">키즈씽킹</h4>
      </div>
      <div class="modal-body text-center">
        <img class="character" />
        로그인에 성공하였습니다!
      </div>
      <div class="modal-footer">
        <a id="goNext" href="#" data-dismiss="modal" class="close-modal btn btn-default" tabindex="0">확인</a>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="modal-fail" class="modal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close" tabindex="0"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">키즈씽킹</h4>
      </div>
      <div class="modal-body text-center">
        로그인에 실패하였습니다!<br>
        다시 시도해주세요.
      </div>
      <div class="modal-footer">
        <button type="button" class="close-modal btn btn-default" data-dismiss="modal" tabindex="0">확인</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<script>
  var code = "<%=code%>";
  var info = <%-typeof info == "undefined" ? "{}" : info%>;
  var names, level, books;
  var view = 0,
      sClassName = null,
      sBook = null;
  var lang = info ? (info.lang || "ko") : "ko",
      msg = {
        ko: {
          welcome: "안녕하세요. 키즈씽킹입니다.",
          school: "홈페이지입니다.",
          login: "키즈씽킹 로그인",
          login1: "로그인 스티커",
          login2: "를 확인해주세요.",
          select_name: "1. 이름을 선택하세요",
          select_password: "2. 비밀캐릭터나 비밀번호를 선택하세요",
          kidsthinking: "키즈씽킹",
          error: "원별 접속주소를 확인해주세요.",
          month: ["1월","2월","3월","4월","5월","6월","7월","8월","9월","10월","11월","12월"]
        },
        en: {
          welcome: "Welcome to KidsThinking",
          school: "",
          login: "Login",
          login1: "Check your login information.",
          login2: "",
          select_name: "1. Select your name.",
          select_password: "2. Select your password.",
          kidsthinking: "KidsThinking",
          error: "Check your url, Please.",
          month: ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
        }
      };

  $("[data-msg]").each(function(idx, el) {
    $(el).text(msg[lang][$(el).data("msg")]);
  });
  if(code == "" || info == null) {
    $("[data-view]").hide();
    $("[data-view=" + view + "]").show();
    $("[data-msg=school]").text(msg[lang].error);
    setTimeout(function() {
      alert("잘못된 경로로 접근하였습니다. 원별 접속 주소를 확인하여 주세요.");
    }, 1);
  } else {
    init();
  }

  function init() {
    $.get("/login/names.json", function(data) {
      names = data;
    });
    $.get("/login/level_pw.json", function(data) {
      level = data;
    });
    $.get("/login/books.json", function(data) {
      books = data;
    });

    $("#names").click('button', function(e) {
      $("#names button").removeClass("selected");
      $(e.target).addClass("selected");
    });
    $("#characters").click('img', function(e) {
      $("#characters img").removeClass("selected");
      $(e.target).addClass("selected");
    });

    showClass();
  }

  function showClass() {
    $("[data-view]").hide();
    $("[data-view=" + view + "]").show();
    $(".school").text(info.school_name || info.school);
    $(".yearmonth").text(msg[lang].month[Number(info.date.slice(4,6))-1]);
    var classes = Object.keys(info.classes).map(function(item) {
      return info.classes[item];
    }).reduce(function(init, arr) {
      return init.concat(arr);
    }, []);
    classes.forEach(function(className, i) {
      var $button = $('<a href="#" data-classname="' + className + '" class="btn btn-lg btn-default">' + className + '</a>');
      if(code == "a819b") {
        var book = Object.keys(info.classes).filter(function(item) {
          return info.classes[item].indexOf(className) >= 0;
        })[0];
        // TODO: 시연용 페이지에서 로그인 건너뛸때 가정학습 기능은 지원하지 않음
        // book = kids ? tokens[1] || "가정심화학습": tokens[0];
        var tokens = book.split(":"),
            kids = false;
        $button.data("book", tokens[0]);
      }
      $button.click(function(e) {
        e.preventDefault();
        sClassName = $(this).data("classname");
        var book = $(this).data("book");
        if(book) {
          sBook = book;
          $(".className").text(sClassName);
          showBook();
        } else {
          showLogin();
        }
      }).appendTo("#classes");
    });
  }

  function showLogin() {
    view = 1;
    $("[data-view]").hide();
    $("[data-view=" + view + "]").show();
    $(window).scrollTop(0);
    $(".className").text(sClassName);
    var yearmonth = info.date,
        levelLogin = Object.keys(info.classes).filter(function(item) {
          return info.classes[item].indexOf(sClassName) >= 0;
        })[0].split("-")[0];

    var classObj = info.logins && info.logins.filter(function(obj) {
      return obj.className == sClassName
    })[0];
    if(classObj && classObj.students && classObj.students.length > 0) {
      names = classObj.students;
    } else if(names[info.school + "-" + sClassName]) {
      names = names[info.school + "-" + sClassName]
    } else {
      names = names["default"];
    }

    names.forEach(function(name, index) {
      var button = '<button data-index="'+index+'" class="btn btn-lg btn-warning">' + (index+1) + " : " + ($.isArray(name) ? name[1] : name) + '</button>';
      $(button).appendTo("#names");
    });

    level = level[levelLogin] || level["default"];
    level.forEach(function(level_pw, index) {
      var img = '<img class="character" data-img="'+(index+1)+'" src="'+level_pw+'"/>';
      $(img).appendTo("#characters");
    });
    var imgs = getImgs(yearmonth, code, sClassName, level);

    $("#login").click(function(e) {
      if($("#characters .selected").length == 0 || $("#names .selected").length == 0) {
        $("#modal-fail").modal('show');
        return;
      }
      var index = $("#names .selected").data("index"),
          img = $("#characters .selected").data("img");
      if(img != imgs[index]) {
        $("#modal-fail").modal('show');
        return;
      }
      var src = $("#characters .selected").attr("src");
      $("#modal img").attr("src", src);
      $("#modal").modal('show');
    });
    $("#goNext").click(function(e) {
      e.preventDefault();
      var book = Object.keys(info.classes).filter(function(item) {
        return info.classes[item].indexOf(sClassName) >= 0;
      })[0];
      var tokens = book.split(":");
      // book = kids ? tokens[1] || "가정심화학습": tokens[0];
      sBook = tokens[0];
      showBook();
    });
  }

  function showBook() {
    view = 2;
    $("[data-view]").hide();
    $("[data-view=" + view + "]").show();
    $(window).scrollTop(0);
    $(".book").text(sBook);
    var lang = info.lang ? "lang=" + info.lang : "";
    books[sBook].forEach(function(item, idx) {
      var isEnTitle = info.lang == "en" && item.length == 3,
          title = isEnTitle ? item[1] : item[0],
          link = item[item.length - 1],
          conn = link.indexOf("#!") >= 0 ? "?" : "#",
          lang2 = lang ? conn + lang : "",
          $el = $('<a class="btn btn-lg btn-outline">').attr("href", link + lang2).appendTo(".contents");
      if(title.indexOf(":") >= 0) {
        $el.append('<div class="book-idx">' + (idx+1) + '</div>');
        title.split(":").forEach(function(text, i) {
          $el.append('<div class="book-' + i + '">' + text + '</div>');
        });
      } else {
        $el.text(title);
      }
    });
  }

</script>
